# AGENTS.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Overview

This is a declarative macOS system configuration using Nix flakes with two layers:
- **nix-darwin**: System-level configuration (requires sudo)
- **home-manager**: User-level configuration (most changes)

The configuration uses `host-info.nix` (auto-generated, git-ignored) to provide system-specific values (hostname, username, homedir, flakedir) that are interpolated throughout the flake.

## Common Commands

### Applying Configuration Changes

**User-level changes** (preferred for most updates):
```fish
home-manager switch --flake .
# Or with alias:
hm:switch

# If file conflicts occur:
home-manager switch --flake . -b backup
```

**System-level changes** (rarely needed):
```fish
sudo -H darwin-rebuild switch --flake .
# Or with alias:
dr:switch
```

### Updating Dependencies

Update all flake inputs to latest versions:
```fish
nix flake update
```

### Installation & Uninstallation

```fish
./install.sh      # Initial setup
./uninstall.sh    # Complete removal
```

### Validation & Testing

**Validate flake syntax:**
```fish
nix flake check
```

**Build without switching (dry-run):**
```fish
# For user config:
home-manager build --flake .

# For system config:
darwin-rebuild build --flake .
```

**Check what would change:**
```fish
# For user config:
nix build .#homeConfigurations.(hostname).activationPackage --dry-run

# For system config:
nix build .#darwinConfigurations.(hostname).system --dry-run
```

### Formatting

Format all Nix files:
```fish
nixfmt **/*.nix
```

## Architecture

### Two-Layer Configuration System

1. **nix-darwin** (`darwinConfiguration` in flake.nix):
   - System packages, fonts, shells
   - GUI applications (requires mac-app-util for proper integration)
   - Touch ID for sudo
   - Shell configuration at system level
   - Activation scripts for system setup
   
2. **home-manager** (`homeConfiguration` in flake.nix):
   - User packages (development tools, CLIs)
   - VSCode with extensions and settings
   - Fish shell aliases and environment variables
   - Podman service with auto-start configuration
   - Application trampolines for persistent permissions (via mac-app-util)

### Key Dependencies

- **mac-app-util**: Creates application trampolines to maintain macOS permissions and proper app integration for GUI applications
- **nix-vscode-extensions**: Provides access to VSCode marketplace extensions
- **nixpkgs**: Package repository (using unstable channel)

### Host Information Pattern

The `host-info.nix` file is generated by `install.sh` and contains:
- `hostname`: Used for darwinConfigurations key
- `username`: Used for homeConfigurations key and user declarations
- `homedir`: User's home directory path
- `flakedir`: Absolute path to this repository

This file is marked with `git update-index --skip-worktree` to prevent it from being committed while remaining tracked in git.

### Flake Structure

The flake exports two configurations:
- `darwinConfigurations.${hostInfo.hostname}`: System configuration
- `homeConfigurations.${hostInfo.username}`: User configuration

Both reference the same `hostInfo` to ensure consistency.

## Development Workflow

### Adding Packages

**User packages** (most common):
Add to `home.packages` in the `homeConfiguration` section, then run `hm:switch`.

**System packages** (GUI apps, fonts):
Add to `environment.systemPackages` or `fonts.packages` in `darwinConfiguration`, then run `dr:switch`.

### Adding VSCode Extensions

Extensions come from the `nix-vscode-extensions` overlay. Add to `programs.vscode.profiles.default.extensions`:
```nix
profiles.default.extensions = with pkgs.vscode-marketplace; [
  publisher.extension-name
];
```

Search for extensions at: https://search.nixos.org/packages (filter by "vscode-extensions")

### Shell Aliases & Environment

**System-level aliases**: Edit `programs.fish.shellAliases` in `darwinConfiguration`
**User-level aliases**: Edit `programs.fish.shellAliases` in `homeConfiguration`
**Environment variables**: Edit `home.sessionVariables` in `homeConfiguration`

### Podman Configuration

The Podman setup includes:
- Automatic machine creation (`podman-machine-default`)
- Auto-start on login via launchd
- Docker CLI compatibility (`docker` command aliased to `podman`)
- podman-compose for Docker Compose compatibility

When modifying Podman settings, edit `services.podman` in `homeConfiguration`.

## Important Notes

### Git Worktree Management

If encountering git permission errors after running commands with sudo:
```fish
sudo chown -R $USER:staff .git
```

### Full Disk Access Requirement

The `determinate-nixd` daemon requires Full Disk Access in System Settings → Privacy & Security. Without this, "operation not permitted" errors will occur when installing applications.

### Activation Scripts

System activation scripts in `darwinConfiguration` automatically:
- Set Fish as the default shell if not already configured
- Only run `chsh` when the current shell differs from the target

Home activation scripts in `homeConfiguration`:
- Create app trampolines using mac-app-util to maintain permissions

### Font Configuration

JetBrains Mono Nerd Font is installed at system level but configured in VSCode and terminal settings in home-manager. Both layers must be applied for fonts to work properly in VSCode.

## Troubleshooting

### Changes Not Applying

Ensure you're using the correct layer:
- GUI apps, fonts, system settings → `dr:switch` (nix-darwin)
- Development tools, VSCode, user configs → `hm:switch` (home-manager)

### Shell Not Changing

Restart terminal or source the Nix environment:
```fish
source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
```

### File Conflicts in home-manager

Use the backup flag:
```fish
home-manager switch --flake . -b backup
```

## Resources

- Nix Package Search: https://search.nixos.org/packages
- Nix Darwin Options: https://daiderd.com/nix-darwin/manual/index.html
- Home Manager Options: https://nix-community.github.io/home-manager/options.xhtml
